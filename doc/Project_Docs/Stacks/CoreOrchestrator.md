# Core Orchestrator Stack

**Version:** 0.1.0  
**Last Updated:** 2025-10-22  
**Scope:** автономное ядро CodeAI-Hub, обеспечивающее работу всех UI-клиентов и провайдерных модулей.

---

## Purpose
Core Orchestrator — независимый Node.js-сервис, который загружается вместе с расширением CodeAI-Hub и продолжает работу после закрытия VS Code. Он управляет жизненным циклом сессий, взаимодействует с провайдерами, обслуживает Remote UI Bridge и обеспечивает единый контракт для всех клиентов (webview, локальный PWA, будущие удалённые интерфейсы).

## Component Map
- **Remote UI Bridge** — HTTP/WebSocket шлюз. Поднимает `/ws` для потоковых событий и `/auth` для получения токенов. Поддерживает multiplex нескольких клиентов.
- **Session Manager** — отвечает за создание/удаление сессий, хранение истории, черновиков и состояний визардов. Реализует восстановление после рестарта (persist на файловой системе).
- **Provider Registry** — хранит метаданные о доступных провайдерах, их возможностях и точках входа. Выполняет ленивую загрузку модулей и следит за совместимостью API.
- **Module Loader & Update Service** — скачивает провайдерные пакеты и их зависимости, проверяет подписи/хэши, управляет версионностью через manifest (`~/.codeai-hub/manifest.json`).
- **Workflow Layer** — плагины оркестраций (визарды, multi-agent сценарии), использующие единый контракт провайдеров и сервисы Session Manager.
- **Config & Secrets Service** — хранит пользовательские настройки, пути к CLI, токены авторизации. Обеспечивает шифрование секретов и выдачу временных ключей клиентам.
- **Telemetry & Logging** — формирует журналы (`logs/`), метрики состояния и трассировки потоков. Предоставляет API для чтения последних ошибок web-клиентам.

## Deployment & Startup
1. Во время установки VSIX расширение проверяет директорию `~/.codeai-hub/core`. При отсутствии скачивает архив ядра (tarball) из публичного источника и распаковывает рядом с `providers/`.
2. При активации расширение запускает процесс ядра (`node core/dist/index.js`) в режиме сервиса. Обмен командой происходит через локальный сокет/WebSocket.
3. Перед запуском ядро проверяет целостность файлов, корректность версий Node и наличие обязательных каталогов (`core/`, `providers/`, `logs/`, `cache/`).
4. При обновлении VSIX расширение сверяет контрольные суммы и при необходимости скачивает новую версию ядра. Старые версии архивируются в `core/archive/` с возможностью rollback.

## API & Protocols
- **HTTP**
  - `GET /health` — быстрая проверка готовности (возвращает версию ядра и статус модулей).
  - `POST /auth/token` — получает одноразовый токен для подключения клиента (использует секрет, который хранит extension host).
  - `POST /modules/install` — заявка на установку/обновление провайдера (используется только расширением).
- **WebSocket** (`/ws`) — основной канал событий. Поддерживаются типы сообщений:
  - `session:update`, `session:closed`
  - `stream:chunk`, `stream:complete`
  - `workflow:event`, `workflow:error`
  - `settings:changed`, `provider:status`
  - `diagnostics:log`
- **Command API** — extension host может инициировать фоновые задачи через RPC (`core:restart`, `module:refresh`, `shortcut:sync`).

## Data & Storage
- Каталог `~/.codeai-hub/` содержит:
  - `core/` — бинарники и ресурсы ядра.
  - `providers/` — загруженные модули провайдеров, каждый в своём namespace.
  - `logs/` — ротация журналов ядра и провайдеров.
  - `cache/` — промежуточные файлы, индексы, предпросмотры данных.
  - `manifest.json` — список установленных модулей, версии CLI, контрольные суммы.
- Сессии сохраняются в `sessions/<sessionId>.jsonl`. Черновики располагаются в `drafts/<sessionId>.json`. Файлы визардов — в `workflows/`.

## Security & Access Control
- Аутентификация клиентов реализуется через короткоживущие токены. Extension host выступает доверенным брокером, выдавая токен после проверки `SecretStorage`.
- Поддерживается TOTP: пользователи могут подключить приложение-генератор, чтобы получить доступ к ядру из удалённого браузера. Секрет хранится в `secrets/` (зашифрован).
- Для внешних подключений ядро рекомендует TLS через reverse proxy (Caddy/NGINX). Локальные подключения работают по `localhost`.
- Провайдерные ключи изолированы: хранение и обновление выполняется через Config & Secrets Service, UI получает только маскированные значения.

## Observability & Recovery
- Логирование: `core.log` (основные события), `providers/<name>.log`, `bridge.log`.
- Метрики: состояние модулей, число активных сессий, потребление ресурсов. Предусмотрен REST эндпойнт `GET /metrics` для интеграции с внешними инструментами.
- Автовосстановление: при падении воркера провайдера Session Manager инициирует перезапуск, а клиентам отправляется `diagnostics:log` и `provider:status`.
- Резервные копии manifest и конфигураций делаются перед каждым обновлением и хранятся в `backup/`.

## Related Documents
- `doc/Architecture/Architecture.md`
- `doc/Project_Docs/SystemArchitecture/SystemArchitecture.md`
- `doc/tmp/RemoteCoreBridge.md`
