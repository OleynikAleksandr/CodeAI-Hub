# Варианты поставки Chromium Embedded Framework для локального клиента

**Дата:** 2025-10-23  
**Цель:** определить стратегии доставки CEF для замены браузерного запуска локального веб-клиента CodeAI Hub на движок Chromium Embedded Framework.

---

## 1. Официальные автоматизированные сборки CEF
- Источник: https://cef-builds.spotifycdn.com/index.html (`index.json` содержит актуальные версии для всех платформ). Каналы: `stable`, `beta`, реже `experimental`.
- Форматы пакетов:
  - `standard` — полный набор: заголовки, libcef, ICU, ресурсовые пакеты, sample-шаблон.
  - `minimal` — урезанное содержимое для собственных приложений (без sample-проекта и части вспомогательных ресурсов). Подходит для интеграции в наш лаунчер.
  - `client` — бинарный пример `cefclient` (можно использовать как reference, но избыточен для поставки).
  - `tools`, `debug_symbols`, `release_symbols` — отладочные и служебные файлы, не требуются в рабочем пакете.
- Размеры актуальных пакетов (версия `141.0.10+g1d65b0d+chromium-141.0.7390.123`, канал `stable`):

| Платформа | Тип | Имя файла | Размер (архив) |
|-----------|-----|-----------|----------------|
| Windows x64 | `minimal` | `cef_binary_141.0.10..._windows64_minimal.tar.bz2` | 149 МБ |
| Windows x64 | `standard` | `cef_binary_141.0.10..._windows64.tar.bz2` | 315 МБ |
| macOS x64/arm (универсальная) | `minimal` | `cef_binary_141.0.10..._macosx64_minimal.tar.bz2` | 119 МБ |
| macOS x64/arm | `standard` | `cef_binary_141.0.10..._macosx64.tar.bz2` | 292 МБ |
| Linux x64 | `minimal` (канал `beta` для 142.0.4) | `cef_binary_142.0.4..._linux64_beta_minimal.tar.bz2` | 390 МБ |
| Linux x64 | `standard` | `cef_binary_142.0.4..._linux64_beta.tar.bz2` | 824 МБ |

> Примечание: размеры указаны по данным `index.json` на 2025-10-23. После распаковки дисковое пространство увеличивается ~в 2–3 раза.

## 2. Структура содержимого пакетов
- **Windows (`minimal`)**
  - `Release/` — исполняемые и DLL (`libcef.dll`, `chrome_elf.dll`, `snapshot_blob.bin`, `icudtl.dat`, `*.pak`).
  - `Resources/` — файлы ресурсов (англ. локализации, шрифты и т.д.).
  - `include/` — заголовки CEF (нужны для сборки нашего лаунчера).
  - `libcef.lib`, `d3dcompiler_47.dll`, `vk_swiftshader.dll`, `swiftshader/` (если включено).
  - Для упаковки потребуется собственный .exe, собранный из наших исходников на CMake, который будет ссылаться на `libcef.dll` и ресурсы.
- **macOS (`minimal`)**
  - `Chromium Embedded Framework.framework` — основной фреймворк, в который включены все бинарники.
  - `Resources/` (часть внутри `.framework`), `Helpers/` с вспомогательными утилитами.
  - Для запуска нужно собрать `.app` (bundle) с нашим бинарником, подключив фреймворк в `Frameworks/`.
- **Linux (`minimal`)**
  - `Release/` — `libcef.so`, `chrome-sandbox` (требует setuid), `libEGL.so`, `libvk_swiftshader.so`, `icudtl.dat`, `*.pak`.
  - `Resources/` — переводы, шрифты.
  - `include/`, `cmake/` для сборки.
  - Необходимо обеспечить корректную установку SUID-бита для `chrome-sandbox` либо запустить без песочницы (требует флагов и снижения безопасности).

## 3. Стратегии доставки
1. **Загрузка готовых архивов при установке расширения**
   - Хранить список URL и SHA-1 из `index.json` в манифесте.
   - При установке/обновлении расширение скачивает архив, проверяет хэш, распаковывает в `~/.codeai-hub/cef/<platform>/<version>/`.
   - Для Windows и macOS желательно кэшировать установленные версии и выполнять lazy cleanup.
2. **Предварительная сборка собственного лаунчера**
   - Собрать C++ приложение, использующее CEF API и подгружающее наш веб-контент из `media/web-client/dist/`.
   - Поставлять лаунчер отдельно, а пакеты CEF скачивать как зависимость (см. пункт 1).
3. **Самостоятельная сборка CEF** (резервный вариант)
   - Используется только при необходимости кастомных патчей Chromium. Требует `depot_tools`, значительного времени и ресурсов. Пока не планируем.

## 4. Рекомендации
- Использовать `minimal`-пакеты для трёх платформ. Они содержат всё необходимое для запуска, но не включают sample-приложение -> меньше размер.
- Версионировать CEF независимо от версии расширения (в манифесте ядра/CEF хранить `cefVersion`).
- Поддерживать кросс-платформенный скрипт установки, который:
  1. Загружает архив (с прогрессом и проверкой SHA-1).
  2. Распаковывает в целевую директорию.
  3. Создаёт wrapper-скрипты/ярлыки, указывающие на наш лаунчер.
- Для macOS потребуется notarization/подпись собственных `.app`, если планируется распространение за пределами разработческой среды. Пока можно ограничиться ad-hoc подписью.
- На Linux задокументировать требования: наличие `libgtk-3`, `libnss3`, `libx11`, при необходимости установить через пакетный менеджер.
- Поддерживать механизм обновления: при смене версии CEF удалять старые каталоги после успешной установки нового.

## 5. Открытые вопросы
- Нужна ли унификация версии CEF и Chromium между платформами или допускаются разные каналы (например, `beta` для Linux, если `stable` задерживается)?
- Какой формат хранения URL/хэшей удобнее для bootstrap (JSON-манифест в репозитории или генерация во время релиза)?
- Требуются ли ARM64-сборки для Windows (официально пока нет отдельных пакетов; возможно использовать x64 через эмуляцию).
