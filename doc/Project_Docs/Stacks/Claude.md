# Стек Claude для CodeAI-Hub

## Обзор
Приватный модуль стека Claude предоставляет серверную интеграцию для CodeAI-Hub: управляет установкой CLI/SDK Anthropic, авторизацией пользователя и адаптацией потоковых событий Claude к унифицированному контракту расширения. Фронтенд вебвью наследуется из open source проекта `claude-code-fusion`, а стек Claude фокусируется на бэкенде и совместимости с мультистековой архитектурой.

## Взаимодействие с CodeAI-Hub
- **Open source расширение** переиспользует React-вебвью и фасады состояния из `claude-code-fusion`, модифицируя их под общий UI.
- **Приватный модуль Claude** подключается через реестр провайдеров CodeAI-Hub и реализует контракт `installOrUpdate → configure → startSession → streamEvents → stopSession → capabilities`.
- **Коммуникация** между ядром и модулем происходит через унифицированные DTO; отличия Claude нормализуются адаптерами и фасадами сообщений.

## Основные компоненты стека
- **ClaudeInstallerFacade** – проверяет наличие `claude-code` CLI и `@anthropic-ai/claude-agent-sdk`, инициирует глобальную установку/обновление, лочит версии из релиза модуля.
- **SDKManagerFacade** – инициализирует SDK, управляет пулом сессий, синхронизирует настройку `settingSources` и следит за refresh токенами.
- **AuthWorkflowFacade** – запрашивает авторизацию пользователя, поддерживает повторное подтверждение, хранит токены в защищённом keychain (через core-сервис CodeAI-Hub).
- **SessionAdapterFacade** – преобразует события SDK (stream, result, tool_use) в унифицированные сообщения UI, поддерживает resume через JSONL-источник.
- **PersistenceModule** – сохраняет историю сессий и черновики (путь по умолчанию `~/.claude/projects/`), экспортирует resume-потоки для MultiSessionResumer.
- **ToolUsePipeline** – нормализует `tool_use` карточки Claude и маршрутизирует их в общий рендерер инструментов CodeAI-Hub.
- **DiagnosticsLogger** – агрегирует логи установки, авторизации и SDK событий, передаёт их в систему логирования core.

## Жизненный цикл
1. **Установка**: при первом подключении модуль скачивается из приватного репозитория, проверяет CLI/SDK и устанавливает их глобально с флагом `-g`.
2. **Авторизация**: пользователь проходит OAuth/TOTP в соответствии с политикой Anthropic; результаты сохраняются в keychain.
3. **Конфигурация**: ядро передаёт settings (регион, лимиты, режимы stream/thinking). Модуль валидирует параметры и загружает defaults из `claude-code-fusion`.
4. **Запуск сессии**: создаётся `sessionId`, открывается поток SDK, запускаются адаптеры streaming/resume.
5. **Эксплуатация**: модуль поддерживает мультисессионность, персистентность вкладок и resume после перезапуска VS Code.
6. **Обновления**: при старте CodeAI-Hub проверяет релизы CLI/SDK и самого модуля; несовпадение версий инициирует автоматический апдейт.
7. **Завершение**: при остановке сессии освобождаются ресурсы SDK, сохраняются финальные JSONL и черновики, очищаются временные файлы.

## Контракт с ядром
- `installOrUpdate(context)` – возвращает состояние установки, список действий (установлено, обновлено, требуется авторизация).
- `configure(settings)` – принимает рабочие режимы (streaming, thinking, tool_use), пути к хранилищам, лимиты по токенам.
- `startSession(payload)` – создаёт контекст, включает поток событий и возвращает дескриптор для UI.
- `streamEvents(descriptor)` – асинхронный итератор, выдающий унифицированные сообщения (`user`, `assistant`, `tool_call`, `tool_result`, `status`).
- `stopSession(sessionId)` – корректно закрывает поток, инициирует финальное сохранение и публикацию логов.
- `capabilities()` – описывает поддерживаемые функции (streaming, tool_use, файловые операции, resume), минимальную версию CLI/SDK и специфичные лимиты Claude.

## Хранение и конфигурация
- **CLI/SDK**: глобальная установка через `npm`/`brew` (в зависимости от ОС); версии соответствуют релизу модуля.
- **Конфиги модуля**: `~/.config/Code/User/globalStorage/codeai-hub/claude/` (метаданные, кеш, telemetry).
- **Данные провайдера**: `~/.claude/projects/` (JSONL истории, вложения), отдельный namespace для CodeAI-Hub.
- **Секреты**: системный keychain/VS Code Secret Storage, доступ через core-сервис `SecretsFacade`.
- **Логи**: `~/Library/Logs/CodeAI-Hub/claude/` (macOS пример), ротация и сбор по запросу пользователя.

## Обработка ошибок и лимитов
- Автоматические ретраи при сетевых сбоях, падении CLI или истечении токена (до 3 попыток с экспоненциальной паузой).
- Предупреждения пользователю при приближении к тарифным лимитам Anthropic, рекомендация переключиться на резервный провайдер.
- Фатальные ошибки логируются, в UI появляются actionable уведомления с советами (перезагрузить VS Code, переавторизоваться, отключить провайдера временно).
- Дубликаты запросов предотвращаются через idempotency ключи на уровне SDK.

## Безопасность
- Авторизационные данные не кэшируются в plain-text, доступ ограничен core-сервисами.
- CLI запускаются в пользовательской среде без повышения привилегий, команды логируются с маскированием токенов.
- JSONL истории очищаются по требованию пользователя; поддерживается автоматическая ротация по размеру/возрасту.

## Зависимости
- `claude-code` CLI ≥ 1.22.x (streaming + tool_use поддержка).
- `@anthropic-ai/claude-agent-sdk` (глобальная установка, версии синхронизируются с модулем).
- Вспомогательные пакеты: `node-fetch`, `ws`, `keytar` (через зависимости модуля).
- Требуемая версия Node.js ≥ 20.

## План развития
1. Унификация рендера инструментов с новыми UX-паттернами CodeAI-Hub.
2. Поддержка смешанных сессий (Claude + другие провайдеры) с общим инспектором состояний.
3. Расширение визардов подготовки спецификаций: повторное использование `Wizard` фасадов из open source части, адаптация под мультиагентные сценарии.
4. Интеграция с будущим Remote Bridge после стабилизации базовой архитектуры.
